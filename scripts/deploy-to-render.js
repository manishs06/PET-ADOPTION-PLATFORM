/**
 * Interactive Render Deployment Helper
 * This script guides you through deploying to Render step-by-step
 */

const readline = require('readline');
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

function generateSecret(length = 32) {
  return crypto.randomBytes(length).toString('hex');
}

async function main() {
  console.log('\n🚀 PET ADOPTION PLATFORM - RENDER DEPLOYMENT HELPER\n');
  console.log('This script will help you deploy your app to Render.\n');
  
  // Step 1: Generate secrets
  console.log('📝 Step 1: Generating secure secrets...\n');
  const jwtSecret = generateSecret(32);
  const adminSecret = generateSecret(32);
  console.log('✅ Generated JWT_SECRET');
  console.log('✅ Generated FIRST_ADMIN_SECRET\n');
  
  // Step 2: Collect information
  console.log('📋 Step 2: We need some information from you:\n');
  
  const mongodbUri = await question('MongoDB URI (from MongoDB Atlas): ');
  const stripeSecret = await question('Stripe Secret Key (sk_test_... or sk_live_...): ');
  const stripePublishable = await question('Stripe Publishable Key (pk_test_... or pk_live_...): ');
  const imgbbKey = await question('ImgBB API Key: ');
  const emailUser = await question('Gmail address (for sending emails): ');
  const emailPass = await question('Gmail App Password (not regular password): ');
  
  console.log('\n📝 Step 3: Render Configuration\n');
  const renderApiKey = await question('Render API Key (get from https://dashboard.render.com/account/api-keys): ');
  
  // Create .env file
  const envContent = `# Render Environment Variables - Generated by deploy script
# Copy these to Render dashboard after creating your service

# Render API Configuration
RENDER_API_KEY=${renderApiKey}
RENDER_SERVICE_ID=your_service_id_here

# Database
MONGODB_URI=${mongodbUri}

# JWT Configuration
JWT_SECRET=${jwtSecret}
JWT_EXPIRE=7d

# Stripe Configuration
STRIPE_SECRET_KEY=${stripeSecret}
STRIPE_PUBLISHABLE_KEY=${stripePublishable}

# ImgBB Configuration
IMGBB_API_KEY=${imgbbKey}

# Frontend URL (update after deploying frontend)
FRONTEND_URL=https://your-frontend.onrender.com
CORS_ORIGIN=https://your-frontend.onrender.com

# Email Configuration
EMAIL_USER=${emailUser}
EMAIL_PASS=${emailPass}
EMAIL_FROM=FourPaws <${emailUser}>

# Admin Secret
FIRST_ADMIN_SECRET=${adminSecret}

# Auto-set values
NODE_ENV=production
PORT=10000
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=1000
`;

  fs.writeFileSync('.env', envContent);
  console.log('\n✅ Created .env file with your configuration\n');
  
  // Display next steps
  console.log('\n📋 NEXT STEPS TO DEPLOY:\n');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  
  console.log('1️⃣  BACKEND DEPLOYMENT:\n');
  console.log('   a) Go to: https://dashboard.render.com');
  console.log('   b) Click "New +" → "Web Service"');
  console.log('   c) Connect your GitHub repository');
  console.log('   d) Configure these settings:');
  console.log('      • Name: fourpaws-backend');
  console.log('      • Root Directory: FourPaws/backend');
  console.log('      • Build Command: npm install');
  console.log('      • Start Command: npm start');
  console.log('      • Environment: Node');
  console.log('   e) In "Environment" tab, add ALL variables from .env file');
  console.log('   f) Click "Create Web Service"');
  console.log('   g) Wait for deployment (5-10 minutes)');
  console.log('   h) Copy your backend URL (e.g., https://fourpaws-backend.onrender.com)\n');
  
  console.log('2️⃣  FRONTEND DEPLOYMENT:\n');
  console.log('   a) In Render dashboard, click "New +" → "Static Site"');
  console.log('   b) Connect your GitHub repository');
  console.log('   c) Configure:');
  console.log('      • Name: fourpaws-frontend');
  console.log('      • Root Directory: FourPaws/frontend');
  console.log('      • Build Command: npm install && npm run build');
  console.log('      • Publish Directory: dist');
  console.log('   d) Add Environment Variables:');
  console.log(`      • VITE_API_BASE_URL=https://your-backend-url.onrender.com/api`);
  console.log(`      • VITE_IMGBB_API_KEY=${imgbbKey}`);
  console.log(`      • VITE_Payment_Gateway_PK=${stripePublishable}`);
  console.log('   e) Deploy\n');
  
  console.log('3️⃣  UPDATE BACKEND CORS:\n');
  console.log('   a) Go back to backend service → Environment');
  console.log('   b) Update FRONTEND_URL and CORS_ORIGIN with your frontend URL');
  console.log('   c) Redeploy backend\n');
  
  console.log('4️⃣  SET ENVIRONMENT VARIABLES AUTOMATICALLY:\n');
  console.log('   a) After backend is created, get Service ID from URL');
  console.log('   b) Update RENDER_SERVICE_ID in .env file');
  console.log('   c) Run: node scripts/setup-render-env.js\n');
  
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
  console.log('💡 TIP: Keep your .env file safe - it contains secrets!\n');
  
  rl.close();
}

main().catch(console.error);
